<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>pdf mock</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div id="site-container">
    <div id="display-container">
      <div id="controls" class="sidebar">
        <form id="user-input" name="user-input">
          <!--           <select name="paperSize" id="paperSize">
            <option value="a4">a4</option>
            <option value="a5">a5</option>
            <option value="a6">a6</option>
          </select> -->
          <input id="width" name="width" type="number" step="0.125" placeholder="inches wide" required>
          <input id="height" name="height" type="number" step="0.125" placeholder="inches high" required>
          <input id="name" name="name" type="text" placeholder="return name" required>
          <input id="address" name="address" type="text" placeholder="address" required>
          <input id="city" name="city" type="text" placeholder="city, state zip" required>
          <input type="submit" name="submit the form" value="Update Envelope">
        </form>
        <input type="file" id="file-input" accept="text/csv" value="test">
      </div>
      <canvas id="canvas" class="workspace adjust">CANVAS NOT SUPPORTED
      </canvas>
      <div id="envelope" class="paper adjust">
        <div id="address_return" name="address_return" class="address_container adjust">
          <div id="r1" class="text return name">RETURN NAME</div>
          <div id="r2" class="text return">123 SOME STREET</div>
          <div id="r3" class="text return">ANYTOWN, ST 12345</div>
        </div>
        <div id="address_destination" name="address_destination" class="address_container adjust">
          <div class="address_dest_group">
            <div id="d1" class="text destination name">DESTINATION NAME</div>
            <div id="d2" class="text destination">123 SOME STREET</div>
            <div id="d3" class="text destination">ANYTOWN, ST 12345</div>
          </div>
        </div>
        <div id="stamp"></div>
      </div>
      <div id="data" class="sidebar"></div>
    </div>
  </div>
  <script>
  const user = document.querySelector('#user-input');
  const adjustableDivs = document.querySelectorAll('.text');
  const envelope = document.querySelector('#envelope');
  const canvas = document.querySelector('#canvas');
  const addressReturn = document.querySelector('#address_return');
  const addressDest = document.querySelector('#address_destination');
  const ctx = canvas.getContext('2d');
  const pdfDPI = 72;
  let canvasX;
  let canvasY;
  let originX;
  let originY;
  let User = { height: "5", width: "9.5" };
  let content = [];

  function center(parent, child) {
    // console.log({ parent, child });
    let marginX = (parent.offsetWidth - child.offsetWidth) / 2;
    let marginY = (parent.offsetHeight - child.offsetHeight) / 2;
    if (parent === canvas) {
      // console.log("parent = canvas");
      originX = marginX;
      originY = marginY;
      marginX += parent.offsetLeft;
      marginY += parent.offsetTop;
    }
    // let newPosX = parent.offsetLeft + marginX;
    // let newPosY = parent.offsetTop + marginY;
    // let moveX = child.offsetLeft + newPosX;
    // let moveY = newPosY - child.offsetTop;
    // console.log({ marginX, newPosX, moveX, marginY, newPosY, moveY });
    // child.style.transform = `translate(${moveX}px, ${moveY}px`;
    child.style.left = marginX + "px";
    child.style.top = marginY + "px";
    // console.log({ moveX, moveY });
  }

  function canvasInit(x = 1000, y = 500) {
    canvas.style.width = `${x}px`; // Set display size (css pixels).
    canvas.style.height = `${y}px`;
    canvasX = x;
    canvasY = y;
    let scale = window.devicePixelRatio; // Change to 1 on retina screens to see blurry canvas.
    canvas.width = x * scale; // Set actual size in memory (scaled to account for extra pixel density).
    canvas.height = y * scale;
    ctx.scale(scale, scale); // Normalize coordinate system to use css pixels.
  }

  function displayGridLines(color = 'lightblue', width = 1, offsetX = originX, offsetY = originY, interval = pdfDPI) {
    while (offsetX > interval) offsetX -= interval;
    while (offsetY > interval) offsetY -= interval;
    if (!offsetX) offsetX = (canvasX % pdfDPI) / 2;
    if (!offsetY) offsetY = (canvasY % pdfDPI) / 2;
    ctx.lineWidth = width;
    ctx.strokeStyle = color;
    for (i = offsetX; i < canvasX; i) {
      ctx.moveTo(i, 0);
      ctx.lineTo(i, canvasY);
      ctx.stroke();
      i += interval;
    }
    for (i = offsetY; i < canvasY; i) {
      ctx.moveTo(0, i);
      ctx.lineTo(canvasX, i);
      ctx.stroke();
      i += interval;
    }
  }

  function setup() {
    canvasInit();
    if (User.width) {
      pxX = User.width * pdfDPI;
      pxY = User.height * pdfDPI;
      envelope.style.width = pxX + "px";
      envelope.style.height = pxY + "px";
    }
    if (User.name) document.querySelector('#r1').innerText = User.name;
    if (User.address) document.querySelector('#r2').innerText = User.address;
    if (User.city) document.querySelector('#r3').innerText = User.city;
    center(canvas, envelope);
    // center(envelope, addressDest);
    displayGridLines();
  }

  function handleResize() {
    center(canvas, envelope);
    displayGridLines();
  }

  function handleClick(e) {
    event.stopPropagation();
    getCoords(e.target);
  }

  function getCoords(origin) {
    // console.log(origin);
    let xCoord = addOffsets("x", origin);
    let yCoord = addOffsets("y", origin);

    function addOffsets(dir, target) {
      let offset = 0;
      for (i = 0; i < 20; i++) {
        (dir === "x") ? offset += target.offsetLeft: offset += target.offsetTop;
        target = target.offsetParent;
        // console.log(offset);
        // console.log(target.id);
        if (target.id === "envelope") {
          i = 20;
        }
      }
      return offset;
    }
    // console.log([xCoord, yCoord]);
    return [xCoord, yCoord];

  }

  function handleUser(e) {
    e.preventDefault();
    for (i = 0; i < e.target.length - 1; i++) {
      let name = e.target[i].name;
      let value = e.target[i].value;
      User[name] = value;
    }
    console.log(User);
    setup();
  }

  function test() {
    let i = 0;
    content = [];
    adjustableDivs.forEach(item => {
      content[i] = getCoords(item);
      console.log(item);
      content[i].push(item.innerText);
      content[i].push(item.id);
      i++;
    });
    console.log(content); //and USER
  }

  user.addEventListener("submit", handleUser);
  window.addEventListener("load", setup);
  window.addEventListener("resize", handleResize)
  adjustableDivs.forEach(adjustableDiv => adjustableDiv.addEventListener('click', handleClick));

  //file loader begins---
  let csvData = [];

  document.querySelector("#file-input").addEventListener('change', function() {
    // files that user has chosen
    var all_files = this.files;
    if (all_files.length == 0) {
      alert('Error : No file selected');
      return;
    }
    // first file selected by user
    var file = all_files[0];

    // files types allowed
    var allowed_types = ['text/csv'];
    if (allowed_types.indexOf(file.type) == -1) {
      alert('Error : Incorrect file type');
      return;
    }

    // Max 2 MB allowed
    var max_size_allowed = 2 * 1024 * 1024
    if (file.size > max_size_allowed) {
      alert('Error : Exceeded size 2MB');
      return;
    }

    // file validation is successfull
    // we will now read the file

    var reader = new FileReader();

    // file reading started
    reader.addEventListener('loadstart', function() {
      // document.querySelector("#file-input-label").style.display = 'none'; 
    });

    // file reading finished successfully
    reader.addEventListener('load', function(e) {
      var text = e.target.result;
      processData(text);

      // document.querySelector("#file-input-label").style.display = 'block'; 
    });

    function processData(csv) {
      var allTextLines = csv.split(/\r\n|\r|\n/);
      csvData = [];
      for (var i = 0; i < allTextLines.length; i++) {
        var data = allTextLines[i].split(/,/);
        var tarr = [];
        for (var j = 0; j < data.length; j++) {
          let str = data[j];
          tarr.push(str);
        }
        csvData.push(tarr);
      }
      console.log(csvData);
    }

    // const addressObject = (keys...)



    // read as text file
    reader.readAsText(file);
  });
  </script>
</body>

</html>